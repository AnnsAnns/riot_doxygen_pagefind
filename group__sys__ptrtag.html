<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RIOT OS: Helpers for pointer tagging</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<!-- <script type="text/javascript" src="jquery.js"></script> -->
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<!-- <link href="/pagefind/pagefind-ui.css" rel="stylesheet"> -->
<script src="/pagefind/pagefind-ui.js"></script>
<script>
  // Check whether the PagefindUI class is available
  if (typeof PagefindUI === 'undefined') {
    console.error('PagefindUI class is not available | Dev Build');
  } else {
    // // Remove the "searchstub" element and initialize the PagefindUI class
    // document.getElementById("#searchstub").remove();
    // Initialize the PagefindUI class with the element id "search"
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
  }
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="global.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <script>
    // Print the data within the NAVTREE variable from the navtreedata.js file
    var navtree = NAVTREE;
    console.log(navtree);
  </script>
<div class="flex flex-row gap-4 w-screen font-sans text-lg max-h-screen overscroll-contain justify-items-stretch bg-neutral-900">
  <!--Sidebar-->
  <div data-pagefind-ignore="all" class="w-1/3 max-w-md flex-auto h-screen bg-neutral-800 ring-2 ring-neutral-700 shadow-neutral-800 shadow-2xl rounded-xl p-3 ml-1 my-2 mr-3 flex flex-col justify-around">
    <div id="top" class="justify-self-center content-center items-center place-content-center">
      <img alt="Logo" src="riot-logo.svg"/>
      <div id="projectbrief">
        The friendly Operating System for the Internet of Things
      </div>
    </div>
    <div id="search" class="place-content-center" class="overflow-y-scroll max-h-64 bg-slate-400 ring-2 ring-white text-white" >
      <h1>Searchbar via Pagefind</h1>
      <!-- <div id="searchstub" class="flex items-center border border-gray-300 rounded-lg p-2 shadow-sm">
        <input type="text" placeholder="Search is only available in Production Build ..." class="flex-grow p-2 outline-none">
      </div> -->
    </div>
    <div id="navtree">
      <script>
        // The navtree variable is always a pair of two elements (key, value)
        // The key is the name we should display and the value is the link to the page
        // Generate the navtree from the navtreedata.js file and put it under the navtree div
        var navtree = NAVTREE[0][2];
        var navtreeHTML = "<h1>Navigation based on Doxygen</h1> <ul>";
        for (var i = 0; i < navtree.length; i++) {
          navtreeHTML += "<li><a href='" + navtree[i][1] + "'>" + navtree[i][0] + "</a></li>";
          if (i == 5) {
            navtreeHTML += '<li><h3 class="ring-2 ring-white"> Random Insert for Demonstration </h3></li>';
          }
        }
        navtreeHTML += "</ul>";
        document.getElementById("navtree").innerHTML = navtreeHTML;
      </script>
    </div>
    <ul>
      <li class="footer">
        Generated on Tue Sep 24 2024 11:16:26 by 
          <a href="http://www.doxygen.org/index.html">
            Doxygen
          </a> 
        1.12.0
      </li>
    </ul>
  </div>
  <!--Main Content-->
  <div class="hidden">
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search',true);
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('group__sys__ptrtag.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#files">Files</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">Helpers for pointer tagging<div class="ingroups"><a class="el" href="group__sys.html">System</a></div></div></div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h1><a class="anchor" id="autotoc_md2093"></a>
Concept</h1>
<p>Data structures are often aligned in memory to the word size. On 32 bit machines, this often results in the two least significant bits containing no information (as they have to be zero, due to this alignment). In many cases gaining two bits of information storage in RAM is all you need. In these case, pointer tagging can come in handy.</p>
<p>The tricky part is however to get this working portable on all architectures, possibly even on 8 bit machines that have no alignment requirements. This utility provides helpers to enforce alignment requirements for all platforms, so that pointer tagging can be used everywhere.</p>
<h1><a class="anchor" id="autotoc_md2094"></a>
Usage</h1>
<div class="fragment"><div class="line"> <span class="comment">// Use the PTRTAG attribute to ensure that pointers to this structure can</span></div>
<div class="line"> <span class="comment">// be tagged, even if structure would not have a suitable alignment</span></div>
<div class="line"> <span class="comment">// otherwise</span></div>
<div class="line"> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code hl_struct" href="structPTRTAG.html">PTRTAG</a> {</div>
<div class="line">    uint32_t bar;</div>
<div class="line">} foo_t;</div>
<div class="line"> </div>
<div class="line"> <span class="keywordtype">void</span> isr_callback(<span class="keywordtype">void</span> *data) {</div>
<div class="line">     <span class="comment">// extract pointer</span></div>
<div class="line">     <span class="keyword">struct </span>foo *ptr = <a class="code hl_function" href="#ga6a059f384d13a1fffc068efdb06647c6">ptrtag_ptr</a>(data);</div>
<div class="line">     <span class="comment">// extract tag</span></div>
<div class="line">     uint8_t tag = <a class="code hl_function" href="#ga31600722dd3fa9490e2b8fbf9ce21de6">ptrtag_tag</a>(data);</div>
<div class="line">     work_on_data(ptr, tag);</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line"> <span class="keywordtype">int</span> main(<span class="keywordtype">void</span>) {</div>
<div class="line">     foo_t data;</div>
<div class="line">     uint8_t tag = 3;</div>
<div class="line">     <span class="comment">// pack pointer and tag into tagged pointer</span></div>
<div class="line">     <span class="keywordtype">void</span> *ptr_and_tag = <a class="code hl_function" href="#gab7eebd12ebd7c7103e25c5061bdbb681">ptrtag</a>(&amp;data, tag);</div>
<div class="line">     init_isr(params, isr_callback, ptr_and_tag);</div>
<div class="line"> }</div>
<div class="ttc" id="agroup__sys__ptrtag_html_ga31600722dd3fa9490e2b8fbf9ce21de6"><div class="ttname"><a href="#ga31600722dd3fa9490e2b8fbf9ce21de6">ptrtag_tag</a></div><div class="ttdeci">static uint8_t ptrtag_tag(void *tagged_ptr)</div><div class="ttdoc">Extract the tag from a tagged pointer.</div><div class="ttdef"><b>Definition</b> <a href="ptrtag_8h_source.html#l00115">ptrtag.h:115</a></div></div>
<div class="ttc" id="agroup__sys__ptrtag_html_ga6a059f384d13a1fffc068efdb06647c6"><div class="ttname"><a href="#ga6a059f384d13a1fffc068efdb06647c6">ptrtag_ptr</a></div><div class="ttdeci">static void * ptrtag_ptr(void *tagged_ptr)</div><div class="ttdoc">Extract the original pointer from a tagged pointer.</div><div class="ttdef"><b>Definition</b> <a href="ptrtag_8h_source.html#l00103">ptrtag.h:103</a></div></div>
<div class="ttc" id="agroup__sys__ptrtag_html_gab7eebd12ebd7c7103e25c5061bdbb681"><div class="ttname"><a href="#gab7eebd12ebd7c7103e25c5061bdbb681">ptrtag</a></div><div class="ttdeci">static void * ptrtag(void *ptr, uint8_t tag)</div><div class="ttdoc">Create a tagged pointer.</div><div class="ttdef"><b>Definition</b> <a href="ptrtag_8h_source.html#l00090">ptrtag.h:90</a></div></div>
<div class="ttc" id="astructPTRTAG_html"><div class="ttname"><a href="structPTRTAG.html">PTRTAG</a></div><div class="ttdoc">event queue structure</div><div class="ttdef"><b>Definition</b> <a href="event_8h_source.html#l00156">event.h:156</a></div></div>
</div><!-- fragment --> <table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="ptrtag_8h.html">ptrtag.h</a></td></tr>
<tr class="memdesc:ptrtag_8h"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pointer Tagging Helpers. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:gadf582752ab291dd35ccf02c188f65d16" id="r_gadf582752ab291dd35ccf02c188f65d16"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gadf582752ab291dd35ccf02c188f65d16">PTRTAG</a>&#160;&#160;&#160;__attribute__((aligned(4)))</td></tr>
<tr class="memdesc:gadf582752ab291dd35ccf02c188f65d16"><td class="mdescLeft">&#160;</td><td class="mdescRight">Pointers to data marked with this attribute will be tag-able.  <br /></td></tr>
<tr class="separator:gadf582752ab291dd35ccf02c188f65d16"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gab7eebd12ebd7c7103e25c5061bdbb681" id="r_gab7eebd12ebd7c7103e25c5061bdbb681"><td class="memItemLeft" align="right" valign="top">static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#gab7eebd12ebd7c7103e25c5061bdbb681">ptrtag</a> (void *ptr, uint8_t tag)</td></tr>
<tr class="memdesc:gab7eebd12ebd7c7103e25c5061bdbb681"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create a tagged pointer.  <br /></td></tr>
<tr class="separator:gab7eebd12ebd7c7103e25c5061bdbb681"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga6a059f384d13a1fffc068efdb06647c6" id="r_ga6a059f384d13a1fffc068efdb06647c6"><td class="memItemLeft" align="right" valign="top">static void *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ga6a059f384d13a1fffc068efdb06647c6">ptrtag_ptr</a> (void *tagged_ptr)</td></tr>
<tr class="memdesc:ga6a059f384d13a1fffc068efdb06647c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Extract the original pointer from a tagged pointer.  <br /></td></tr>
<tr class="separator:ga6a059f384d13a1fffc068efdb06647c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga31600722dd3fa9490e2b8fbf9ce21de6" id="r_ga31600722dd3fa9490e2b8fbf9ce21de6"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ga31600722dd3fa9490e2b8fbf9ce21de6">ptrtag_tag</a> (void *tagged_ptr)</td></tr>
<tr class="memdesc:ga31600722dd3fa9490e2b8fbf9ce21de6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Extract the tag from a tagged pointer.  <br /></td></tr>
<tr class="separator:ga31600722dd3fa9490e2b8fbf9ce21de6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="gadf582752ab291dd35ccf02c188f65d16" name="gadf582752ab291dd35ccf02c188f65d16"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gadf582752ab291dd35ccf02c188f65d16">&#9670;&#160;</a></span>PTRTAG</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define PTRTAG&#160;&#160;&#160;__attribute__((aligned(4)))</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Pointers to data marked with this attribute will be tag-able. </p>
<p>This will ensure a minimum alignment of 4 bytes </p>

<p class="definition">Definition at line <a class="el" href="ptrtag_8h_source.html#l00077">77</a> of file <a class="el" href="ptrtag_8h_source.html">ptrtag.h</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="gab7eebd12ebd7c7103e25c5061bdbb681" name="gab7eebd12ebd7c7103e25c5061bdbb681"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gab7eebd12ebd7c7103e25c5061bdbb681">&#9670;&#160;</a></span>ptrtag()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void * ptrtag </td>
          <td>(</td>
          <td class="paramtype">void *</td>          <td class="paramname"><span class="paramname"><em>ptr</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t</td>          <td class="paramname"><span class="paramname"><em>tag</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Create a tagged pointer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">ptr</td><td>Pointer to tag </td></tr>
    <tr><td class="paramname">tag</td><td>Tag to add </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Tagged pointer encoding both <code>ptr</code> and <code>tag</code> </dd></dl>
<dl class="section pre"><dt>Precondition</dt><dd><code>ptr</code> points to data marked with <a class="el" href="structPTRTAG.html">PTRTAG</a> </dd>
<dd>
<code>tag</code> contains a two bit value (its numeric value 0, 1, 2, or 3)</dd></dl>
<p>Expect assertions blowing up when the preconditions are not met. </p>

<p class="definition">Definition at line <a class="el" href="ptrtag_8h_source.html#l00090">90</a> of file <a class="el" href="ptrtag_8h_source.html">ptrtag.h</a>.</p>

</div>
</div>
<a id="ga6a059f384d13a1fffc068efdb06647c6" name="ga6a059f384d13a1fffc068efdb06647c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga6a059f384d13a1fffc068efdb06647c6">&#9670;&#160;</a></span>ptrtag_ptr()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void * ptrtag_ptr </td>
          <td>(</td>
          <td class="paramtype">void *</td>          <td class="paramname"><span class="paramname"><em>tagged_ptr</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Extract the original pointer from a tagged pointer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tagged_ptr</td><td>The tagged pointer to extract the original pointer from </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The original "un-tagged" pointer encoded in <code>tagged_ptr</code> </dd></dl>

<p class="definition">Definition at line <a class="el" href="ptrtag_8h_source.html#l00103">103</a> of file <a class="el" href="ptrtag_8h_source.html">ptrtag.h</a>.</p>

</div>
</div>
<a id="ga31600722dd3fa9490e2b8fbf9ce21de6" name="ga31600722dd3fa9490e2b8fbf9ce21de6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga31600722dd3fa9490e2b8fbf9ce21de6">&#9670;&#160;</a></span>ptrtag_tag()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static uint8_t ptrtag_tag </td>
          <td>(</td>
          <td class="paramtype">void *</td>          <td class="paramname"><span class="paramname"><em>tagged_ptr</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Extract the tag from a tagged pointer. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">tagged_ptr</td><td>The tagged pointer to extract the original pointer from </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>The tag encoded into <code>tagged_ptr</code> </dd></dl>

<p class="definition">Definition at line <a class="el" href="ptrtag_8h_source.html#l00115">115</a> of file <a class="el" href="ptrtag_8h_source.html">ptrtag.h</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->

    </div>
  </body>
</html>
